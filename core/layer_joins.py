# -*- coding: utf-8 -*-
"""
/***************************************************************************
 ThematicMapTools
                                 A QGIS plugin
 Tools for designing thematics maps
 Generated by Plugin Builder: http://g-sherman.github.io/Qgis-Plugin-Builder/
                              -------------------
        begin                : 2021-01-23
        git sha              : $Format:%H$
        copyright            : (C) 2021 by CAMELLonCASE
        email                : camelloncase@gmail.com
 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
"""


import os.path
import time
from qgis.core import Qgis, QgsVectorLayer, QgsRasterLayer, QgsMessageLog, QgsVectorLayerJoinInfo, QgsProject, QgsWkbTypes
from qgis.PyQt.Qt import QObject, QVariant, Qt
from qgis.PyQt.QtWidgets import QProgressBar, QMessageBox
from qgis.PyQt.QtCore import *
from qgis.utils import iface
from qgis.gui import QgsMessageBar


class VectorLayerJoins(QObject):
    """Docstring"""

    def __init__(self, parent=None):
        super(VectorLayerJoins, self).__init__()
        self.parent = parent
        self.layers = QgsProject.instance().mapLayers()
        self.spatial, self.nonSpatial, self.toRemove = [], [], []
        self.getLayers()
        # self.createPairDict()
        #self.removeJoinTables()

    def getLayers(self):
        """Get the spatial and non spatial layers"""
        for layer, v in self.layers.items():
            if isinstance(v, QgsRasterLayer):
                pass
            elif isinstance(v, QgsVectorLayer):
                if QgsWkbTypes.displayString(v.wkbType()) == 'NoGeometry':
                    self.nonSpatial.append(v)
                else:
                    self.spatial.append(v)

    def createPairDict(self):
        """Docstring"""
        self.pairDict = dict()
        for item in self.spatial:
            for nitem in self.nonSpatial:
                if item.name() == nitem.name():
                    self.pairDict[item] = nitem
                    self.nonSpatial.remove(nitem)
        return self.pairDict

    def removeNonSpatial(self):
        """Docstring"""
        for camada in self.toRemove:
            QgsProject.instance().removeMapLayer(camada.id())

    def vectorLayerJoin(self):
        """Docstring"""
        pairs = self.createPairDict()
        self.testForJoins(pairs)

        for layer, table in pairs.items():
            target = layer
            layerToJoin = table
            join = QgsVectorLayerJoinInfo()
            join.setJoinFieldName('id_feature')
            join.setTargetFieldName('id')
            join.setJoinLayerId(layerToJoin.id())
            join.setUsingMemoryCache(True)
            join.setEditable(True)
            join.setDynamicFormEnabled(True)
            join.setUpsertOnEdit(True)
            join.setPrefix('')
            join.setJoinFieldNamesSubset(['legenda', 'ocultar', 'tamanhotxt',
                                          'style', 'casetxt', 'flspacing',
                                          'fwspacing', 'justtxt', 'orient_txt',
                                          'orient_simb', 'offset_quad',
                                          'offset_txt','offset_txt_x',
                                          'offset_txt_y', 'offset_simb',
                                          'offset_simb_x', 'offset_simb_y',
                                          'priority'])
            join.setJoinLayer(layerToJoin)
            target.addJoin(join)
            layerToJoin.startEditing()
            target.triggerRepaint()
        self.showMessage('Info', 'All joins were maded!', 0, True)

    def removeJoinTables(self, layer=None, table=None):
        """Docstring"""
        if layer or table:
            target = layer
            layerToDisjoin = table
            target.removeJoin(layerToDisjoin.id())
            target.triggerRepaint()
        else:
            pairs = self.createPairDict()
            for lyr, tbl in pairs.items():
                target = lyr
                layerToDisjoin = tbl
                target.removeJoin(layerToDisjoin.id())
                target.triggerRepaint()
        self.showMessage('Success', 'All joins were removed!', 3, False)

    def testForJoins(self, pairDict):
        """Docstring"""
        for layer, table in pairDict.items():
            if layer.joinBuffer().containsJoins():
                self.removeJoinTables(layer, table)

    def showMessage(self, title, text, level, verification=False):
        """Docstring"""
        # fix the progreemesssagebar
        # progressMessageBar = iface.messageBar().createMessage("Removing vector layer joins...")
        # progress = QProgressBar()
        # progress.setMaximum(10)
        # progress.setAlignment(Qt.AlignLeft|Qt.AlignVCenter)
        # progressMessageBar.layout().addWidget(progress)
        # iface.messageBar().pushWidget(progressMessageBar, Qgis.Info)

        # for i in range(10):
        #     time.sleep(1)
        #     progress.setValue(i + 5)

        # iface.messageBar().clearWidgets()
        msg = QMessageBox()
        msg.setWindowTitle(self.tr("Setup vector layer joins"))

        if verification:
            msg.setIcon(QMessageBox.Warning)
            msg.setText(self.tr("Already exists some vector layer joins!"))
            msg.setInformativeText(
                self.tr("Do you want to ignore and continue or cancel?"))
            formatedMsgString = self.tr(
                'If you ignore and continue the existent joins will be removed and new ones will be made.')

            msg.setDetailedText(formatedMsgString)
            msg.setStandardButtons(QMessageBox.Ignore | QMessageBox.Cancel)
            msg.setDefaultButton(QMessageBox.Ignore)

            choice = msg.exec_()
            return choice

        else:
            iface.messageBar().pushMessage(self.tr(title),
                                       self.tr(text),
                                       level=level,
                                       duration=3)






